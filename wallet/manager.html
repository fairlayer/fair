<html>

<body>
<style>
  body {

        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }

#plotnext{
  height: 40px;
}
.left{display: inline-block; border: 1px; float:left;
}
.right{display: inline-block; border: 1px; float:right;}





.circle {
  margin: 1px; display: inline-block;
  border-radius: 0%;
  min-width: 80px;
  height: 30px;
  border: 1px solid black;
  position: inline;
}

.yellow{background: yellow;}
.red{background: #ffcccb;}
.blue{background: #87cefa;}
.green{background: green;}

.empty{background: none; border: none;}


</style>
<script src="js/identicon.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jdenticon@1.7.2"></script>



<script>
ownerBalance = 0
state = {}
maxrisk = 4

lock = false


function toImg(hash){
  hash = Benc(nacl.hash(Udec(hash)))
  return '<img width=16 src="data:image/png;base64,'+new Identicon(hash,100).toString()+'">';
}

to_ratio = function(t){
  return Math.round(t*100)
}

render = function(msg){
  //if(lock) return false;

  lock = true;
  for(id in state){
    u = getUser(id)
    if(u.delta < -5){
      ownerBalance -= u.delta
      u.collateral += u.delta
      u.delta = 0
    }
  }
  for(id in state){
    u = getUser(id)
    if(u.delta > 5){
      if(ownerBalance >= u.delta){
        ownerBalance -= u.delta;
        u.collateral += u.delta
        u.delta = 0
      }else{
        u.delta -= ownerBalance
        u.collateral += ownerBalance
        ownerBalance = 0
      }
    }
  }


  st=Object.values(state).sort((a,b)=>{
    [a,b]=[getUser(a.name).delta,getUser(b.name).delta]

    return a>b;
  })


  table = ''
  var hubs = 0
  var owes = 0
  for(id in st){
    id = st[id].name
    var u = getUser(id)

    request_rebalance = ''

    if(u.delta > 50){
      request_rebalance = "<b><span title='Positive delta too big. Request a payment channel'>&#9888;</span></b>"
    }


      var bricks = "<div class='yellow circle'>"+u.collateral+"</div> "

      if(u.delta < 0){
        bricks += "<div class='"+((u.delta<-maxrisk)?"blue":"")+" circle'>"+u.delta+'</div>'
        hubs += u.delta

      }else{
        bricks += "<div class='"+((u.delta>maxrisk)?"red":"")+" circle'>+"+u.delta+"</div>"
        owes += u.delta
      }

      bricks += " = <div class=circle>"+(u.collateral+u.delta)+"</div>"


    table += `<div class="right"> ${id} ${request_rebalance} ${bricks} </div><br><br>`


    }
  anim.innerHTML= `Hub balance: ${ownerBalance}. ${hubs} ins ${owes} outs<br>`+table+` </table>`


  lock = false;
  return hubs;
}



function ts(){
  return Math.round(new Date())
}

function avg(matrix, now){
  var from = now - 100 //matrix[0][0]
  var area = 0
  for(var i = 0;i<matrix.length;i++){
    var this_point = matrix[i]
    var next_point = matrix[i+1]

    if(next_point){
      if(this_point[0] < from){
        if(next_point[0] > from){
          period_from = from
        }else{
          continue;
        }
      }else{
        period_from = this_point[0]
      }

      period_to = next_point[0]
    }else{
      period_from = this_point[0]
      period_to = now
    }
    area += (period_to - period_from) * this_point[1]
  }
  return area / (now - from)
}

function snapshot(id){
  u = getUser(id)
  u.history.push([ts(),  u.delta])
}

//from external addr
function deposit(id, amount){
  var user = getUser(id)
  user.collateral += amount
  snapshot(id)

  render('Deposited from outside '+amount+' BTC to '+id)
}



function getUser(user){
  if(!state[user]) state[user] = {
    delta: 0, 
    collateral: 0,  //total capacity
    name: user,
    history: []
  }

  u = state[user]
  u.total = u.collateral + u.delta

  return u
}

l=console.log
function send(from, to, amount){

  if(getUser(from).total < amount){
    l('Not enough funds')
    return false
  } 

  getUser(from).delta -= amount
  getUser(to).delta += amount

  snapshot(from)
  snapshot(to)

  render()
}

getDigit=function(upto){
  return Math.round(Math.random()*upto)
}

randomUser=function(){
  all = Object.keys(state)
  return all[getDigit(all.length-1)]
}

function randomName(){
  return names[getDigit(names.length-1)]
}

total_users=20
demo=(()=>{
  if(lock) return false
  lock = true;


  if(getDigit(10) < 3){
    user = randomName()
    // no need to deposit more if have enough
    if(getUser(user).total < 10){
      deposit(user, getDigit(5))
    }
  }else{
    var from = randomUser()
    var to = randomName()
    amount = getDigit(6)
    while(from==to){
      var to = randomName()
    }

    if(from!=to){
      var b=getUser(from).total
      if(b<amount) amount = b
      send(from, to, amount)
    }
  }

  lock = false;
})


steps=[
()=>{
  deposit("Alice",20);
  deposit('John', 15)
  deposit('Carol', 15)

  info.innerHTML = `<p>These are payment channels with Hub. Everyone is free to take their money back whenever they wants. There's no custodian risk for senders.</p>

  <p>However, she'd have to wait for a delay period so the blockchain would make sure we won't show any evidence that there are newer payments.</p>`
},

()=>{
  send('Alice', "Coffee Shop", 2)
  info.innerHTML = ``
},
()=>{
  plotnext.style['display'] = 'none'
  int=setInterval(demo, 200)
}

]


window.onload = function(){
  plotnext.onclick = function(){
    steps.shift()()
  }
}

names="Alice Bob Carol Restaurant Waiter AcmeCorp John Dave".split(' ')
</script>

<center >
<div id=anim style="min-height:250px;"></div>


<p><button id="plotnext">Next Slide</button></p>
<div style="max-width:600px" id=info> 

</div>

</center>

</body></html>
